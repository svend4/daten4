name: Auto-Index Templates

on:
  push:
    paths:
      - 'templates/**/*.json'
    branches:
      - main
      - develop
  pull_request:
    paths:
      - 'templates/**/*.json'
  workflow_dispatch:
    inputs:
      template_path:
        description: 'Path to specific template to index'
        required: false

jobs:
  chunk-and-index:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: ğŸ” Find changed templates
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            templates/**/*.json

      - name: ğŸ“‹ List changed templates
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed templates:"
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "  - $file"
          done

      - name: ğŸ”¨ Chunk templates
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ "$file" == *".chunks.json" ]]; then
              echo "â­ï¸  Skipping already chunked file: $file"
              continue
            fi

            echo "ğŸ“¦ Chunking: $file"
            output_file="${file%.json}.chunks.json"

            node scripts/chunk-template.js \
              --input "$file" \
              --output "$output_file" \
              --chunk-size 500

            echo "âœ… Created: $output_file"
          done

      - name: ğŸ¤– Generate embeddings
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "âš™ï¸  Generating embeddings..."
          # TODO: Implement embedding generation script
          # node scripts/generate-embeddings.js
          echo "â­ï¸  Skipping embeddings (implement generate-embeddings.js)"

      - name: ğŸ“Š Generate index report
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "# ğŸ“Š Template Indexing Report" > index-report.md
          echo "" >> index-report.md
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> index-report.md
          echo "**Triggered by:** ${{ github.event_name }}" >> index-report.md
          echo "" >> index-report.md
          echo "## Changed Templates" >> index-report.md
          echo "" >> index-report.md

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ "$file" != *".chunks.json" ]]; then
              echo "- \`$file\`" >> index-report.md

              if [[ -f "${file%.json}.chunks.json" ]]; then
                chunks=$(jq '.chunks | length' "${file%.json}.chunks.json")
                echo "  - Chunks created: $chunks" >> index-report.md
              fi
            fi
          done

          cat index-report.md

      - name: ğŸ’¾ Commit chunked files
        if: steps.changed-files.outputs.any_changed == 'true' && github.event_name == 'push'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Add all .chunks.json files
          git add templates/**/*.chunks.json

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Auto-generated chunks from templates

            - Generated by: GitHub Actions
            - Workflow: ${{ github.workflow }}
            - Run ID: ${{ github.run_id }}
            - Triggered by: ${{ github.event_name }}"

            git push
            echo "âœ… Pushed chunked files"
          fi

      - name: ğŸ“ Create PR comment (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('index-report.md', 'utf8');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: âœ… Success notification
        if: success()
        run: |
          echo "âœ… Template indexing completed successfully"

      - name: âŒ Failure notification
        if: failure()
        run: |
          echo "âŒ Template indexing failed"
          exit 1
